@model CartItemViewModel

@{
    ViewData["Title"] = "Index";
}
<style>
    .table td{
        vertical-align:middle;
    }

    .table th{
        width:15%;
    }
    a{
        cursor:pointer;
    }
    input {
        padding-left:.5rem;
    }

    h2{
        padding-bottom: 5rem;
    }
</style>
<h2>Корзина покупок</h2>

<div class="toast" data-delay="3000" style="position: absolute; bottom: 0; left: 1rem;">
    <div class="toast-header">

        <strong class="mr-auto">Wahama Shop</strong>
        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="toast-body">
        Изменения в корзине применены успешно!
    </div>
</div>

<table class="table table-responsive">
    <thead>
        <tr>
            <th>
                Изображение
            </th>
            <th>
                Наименование
            </th>
            <th>
                Количество
            </th>
            <th>Цена</th>
            <th><span class="spinner-grow spinner-grow-sm d-none" role="status" aria-hidden="true"></span></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @if (Model.CartItem == null)
            {
                                
            }
        
        @foreach (var item in Model.CartItem)
        {
            <tr>
                <td>
                    <img style="width:10.5rem"src="@Html.DisplayFor(modelItem => modelItem.ImageSources[item.Product.Id])" />
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Product.Name)
                </td>
                <td>
                    <input type="number" style="width:70%" id="quantityInput" value="@item.Quantity" />
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Product.Price)
                </td>
                <td>
                    <a onclick="ChangeQuantity(@item.ProductId, @item.Quantity)">Обновить</a>
                </td>
                <td>
                    <a onclick="RemoveFromCart(@item.ProductId)">Удалить</a>
                </td>
            </tr>
        }
    </tbody>
</table>

<script>
    function RemoveFromCart(productId) {
        var _this = $(this);
        var param = {
            quantityDifference: 0,
            productId: productId,
            userId: "CurrentUser"
        };
        $.ajax({
            url: '@Url.Content("~/")' + 'ShoppingCarts/RemoveFromCart',
            contentType: "application/x-www-form-urlencoded",
            type: "POST",
            datatype: "json",

            data: param,
            error: function (xmlHttpRequest, errorText, thrownError) {
                alert(xmlHttpRequest + "|" + errorText + "|" + thrownError);
            },
            success: function (data) {
                if (data != null) {
                    $('.toast').toast('show');
                    location.reload();
                }
            }
        });
    }

    function ChangeQuantity(productId, oldQuantity) {
        var _this = $(this);
        var param = {
            quantityDifference:$('#quantityInput').val() - oldQuantity,
            productId: productId,
            userId: "CurrentUser"
        };
        $.ajax({
            url: '@Url.Content("~/")' + 'ShoppingCarts/RemoveFromCart',
            contentType: "application/x-www-form-urlencoded",
            type: "POST",
            datatype: "json",
            data: param,
            error: function (xmlHttpRequest, errorText, thrownError) {
                alert(xmlHttpRequest + "|" + errorText + "|" + thrownError);
            },
            success: function (data) {
                if (data != null) {
                    $('.toast').toast('show');
                }
            },

        });
    }


</script>